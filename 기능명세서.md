# Mini-EDR v2 기능 명세서 (Detection Capability Specification)
> **version 2.0.1**

본 문서는 Mini-EDR v2 파이프라인을 기반으로  
**현재 탐지 및 수집 가능한 모든 데이터(누락 없음)**와  
**각 기능이 어떤 스크립트에서 구현되는지**를 정리한 명세서이다.

---

# 1. EVTX 원격 수집 (remote_evtx_collect.py)

##  기능 개요
- WinRM을 이용하여 원격 Windows 이벤트 로그 수집
- Security/System/Application 3종 EVTX를 압축하여 전송
- v2_report/<username_timestamp>/evtx 에 저장
- Chainsaw 분석 단계의 입력 데이터 제공

##  수집되는 로그 종류
| 로그 종류 | 설명 |
|----------|------|
| **Security.evtx** | 계정 활동, 인증, 권한 상승, 로그온/로그오프, 정책 변경 |
| **System.evtx** | 서비스 시작/중지, 드라이버 로드, 시스템 오류 |
| **Application.evtx** | 애플리케이션 수준 로그 |
| **PowerShell 실행 흔적** | WinRM 기반 스크립트 실행 이벤트 |

##  활용되는 탐지 로직
- Chainsaw + Sigma 룰 기반 이벤트 행위 분석 (analyze_evtx.py에서 실행)

---

# 2. Chainsaw + Sigma 기반 이벤트 분석 (analyze_evtx.py)

##  기능 개요
- 수집한 EVTX 폴더를 기반으로 Sigma 룰셋에 의해 위협 탐지
- chainsaw_report.json 생성
- MITRE ATT&CK 기반 탐지 이벤트 가능

##  탐지 가능한 공격/행위 유형
| 공격/행위 유형 | 설명 |
|----------------|------|
| **권한 상승 시도** | Admin 그룹 편입, 권한 변경 이벤트 탐지 |
| **의심스러운 프로세스 실행** | LOLBins(mshta, rundll32, powershell -nop 등) |
| **원격 코드 실행** | WinRM, WMI, PSRemoting 흔적 |
| **계정 공격** | RDP brute-force, 로그인 실패 반복, 계정 생성/삭제 |
| **Persistence(지속성)** | 서비스 생성/변경, RunKey, 스케줄 작업 이벤트 |
| **네트워크 공격 흔적** | 방화벽 정책 변경, 포트 오픈/차단, RDP 설정 변경 |
| **이벤트 로그 조작** | 로그 삭제, 보안 로깅 비활성화 |
| **PowerShell 기반 공격** | Base64 인코딩 스크립트, Suspicious command line |
| **Shadow Copy 조작** | 랜섬웨어 초기 단계의 흔적 |

##  탐지 로직 위치
- **analyze_evtx.py**
- Sigma rules: `tools/sigma/rules/windows`
- Chainsaw mapping: `tools/chainsaw/mappings/sigma-event-logs-all.yml`

---

# 3. OSQuery 기반 시스템 포렌식 수집 (osquery_collect.py)

##  기능 개요
Windows OSQuery를 원격 실행하여  
DFIR에 필요한 **시스템 전역 상태**를 JSON으로 모두 수집한다.

수집된 JSON은:  
`v2_report/<username_timestamp>/osquery/*.json`

---

#  OSQuery가 수집 가능한 전체 항목

##  A. 프로세스 & 네트워크
| 항목 | 설명 |
|------|------|
| **processes** | 실행 중인 프로세스 목록 |
| **process_open_sockets** | 프로세스 기반 소켓 연결 |
| **connections** | 네트워크 연결 상태 |
| **listening_ports** | 열려 있는 포트 |

---

##  B. 서비스 / 드라이버 / 커널
| 항목 | 설명 |
|------|------|
| **services** | 서비스 등록 및 상태 |
| **drivers** | 로드된 드라이버 |
| **kernel_drivers** | 커널 드라이버 |

---

##  C. 계정 및 인증(Event bridging)
| 항목 | 설명 |
|------|------|
| **users** | 로컬 사용자 목록 |
| **groups** | 그룹 목록 |
| **user_groups** | 계정-그룹 매핑 |
| **logged_in_users** | 현재 로그인 사용자 |
| **logon_sessions** | 세션 정보 |

---

##  D. Persistence(지속성) 관련
| 항목 | 설명 |
|------|------|
| **startup_items** | 자동 실행 프로그램 |
| **scheduled_tasks** | 예약 작업(task scheduler) |
| **registry_run_hklm/hkcu** | Run 키 지속성 확인 |
| **services / drivers** | 서비스 기반 지속성 탐지 |

---

##  E. 시스템 정보
| 항목 | 설명 |
|------|------|
| **os_version** | OS 버전 |
| **system_info** | 컴퓨터 정보 / BIOS / 모델 |
| **patches** | 설치된 패치 목록 |
| **programs** | 설치된 프로그램 전체 |

---

##  F. 디스크 / 파일시스템
| 항목 | 설명 |
|------|------|
| **disks** | 디스크 구조 |
| **logical_drives** | 논리 드라이브 |
| **mounts** | 마운트된 볼륨 |

---

##  G. 보안 제품 상태
| 항목 | 설명 |
|------|------|
| **windows_security_products** | AV/EDR 존재 여부 |

---

##  H. 네트워크 설정
| 항목 | 설명 |
|------|------|
| **dns_resolvers** | DNS 서버 설정 |
| **interface_addresses** | NIC IP/Mask 정보 |

---

##  I. USB / 주변기기 흔적
| 항목 | 설명 |
|------|------|
| **usb_devices** | 현재 연결된 USB |
| **usb_devices_history** | 과거 USB 연결 이력 |

---

##  J. Chrome 포렌식(웹 활동)
| 항목 | 설명 |
|------|------|
| **chrome_extensions** | 설치된 Chrome 확장 |
| **chrome_history** | 방문 기록 |
| **chrome_cookies** | 쿠키 |

---

##  K. 공격 흔적 기반 DFIR Artifact 테이블
| 항목 | 설명 |
|------|------|
| **prefetch** | Program Execution 흔적 |
| **shimcache** | Application Compatibility Exec logs |
| **amcache** | 설치/실행 흔적 |
| **powershell_events** | PowerShell 로그 |
| **powershell_scripts** | 최근 PS 스크립트 내용 |

---

# 4. 전체 파이프라인 구조 (main.py)

## 단계별 설명
1. **EVTX 수집**
2. **Chainsaw + Sigma 분석**
3. **OSQuery Sweep**
4. **Evidence 통합 저장**

## Evidence 저장 구조
```
v2_report/<username_timestamp>/
├── evtx/
├── chainsaw/
│ └── chainsaw_report.json
├── osquery/
│ └── *.json
└── misc/
├── errors
└── logs
```

---

# 5. 스크립트별 기능 분류표

| 기능 | 스크립트 파일 | 설명 |
|------|----------------|------|
| 원격 EVTX 수집 | `remote_evtx_collect.py` | WinRM PowerShell → EVTX ZIP 생성/전송 |
| 이벤트 기반 위협 탐지 | `analyze_evtx.py` | Chainsaw + Sigma 룰 기반 분석 |
| 시스템/네트워크 상태 수집 | `osquery_collect.py` | OSQuery Sweep 전체 테이블 저장 |
| 전체 파이프라인 오케스트레이션 | `main.py` | 3단계 자동 실행 + Evidence 폴더 생성 |

---

#  결론 (v2 기준)
v2는 다음 범주 전부 탐지/분석 가능:

- Windows Event 기반 공격(Chainsaw + Sigma)
- 실행/네트워크/계정/시스템/USB/브라우저 등 전체 OSQuery 상태
- Persistence 검사(레지스트리, 서비스, 스케줄러)
- 프로그램 실행 흔적(prefetch/shimcache/amcache)
- PowerShell 스크립트 실행 이력
- AV/EDR 상태
- Chrome 활동 기반 분석

즉, **경량 EDR + 초급 디지털포렌식 수집 플랫폼** 수준 완성.

